<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.lghjft.dal.mysql.nrgl.cjwt.CjwtMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器自动生成的 Mapper XML，覆盖率 99% 的场景。
    -->

    <select id="selectPageWithRank" resultType="cn.iocoder.yudao.module.lghjft.dal.dataobject.nrgl.cjwt.CjwtDO">
        SELECT t.*,
        RANK() OVER (ORDER BY t.read_count DESC) as `rank`
        FROM gh_nrgl_cjwt t
        <where>
            t.deleted = 0
            <if test="reqVO.title != null and reqVO.title != ''">
                AND t.title LIKE CONCAT('%', #{reqVO.title}, '%')
            </if>
            <if test="reqVO.status != null">
                AND t.status = #{reqVO.status}
            </if>
            
            <!-- 部门权限过滤 -->
            <if test="loginDeptId != null or (ancestorIds != null and ancestorIds.size() > 0)">
                AND (
                    <!-- 1. 如果有 loginDeptId，匹配本级部门 (可查看所有状态) -->
                    <if test="loginDeptId != null">
                        t.dept_id = #{loginDeptId}
                    </if>
                    
                    <!-- OR -->
                    <if test="loginDeptId != null and ancestorIds != null and ancestorIds.size() > 0">
                        OR
                    </if>
                    
                    <!-- 2. 如果有 ancestorIds，匹配上级部门 (仅查看 完全可见(1) 和 下级可见(2)) -->
                    <if test="ancestorIds != null and ancestorIds.size() > 0">
                        (
                            t.dept_id IN
                            <foreach collection="ancestorIds" item="deptId" open="(" separator="," close=")">
                                #{deptId}
                            </foreach>
                            <!-- 排除本级部门，避免重复 (其实上面已经包含了本级的所有内容，这里主要是为了逻辑清晰，且上级内容有限制) -->
                            <!-- 但注意：如果 loginDeptId 也在 ancestorIds 里（通常不会，ancestor 是上级），或者为了严谨 -->
                            <if test="loginDeptId != null">
                                AND t.dept_id != #{loginDeptId}
                            </if>
                            AND t.kjfw IN (1, 2)
                        )
                    </if>
                )
            </if>
        </where>
        ORDER BY t.sort DESC, t.id DESC
    </select>

</mapper>
